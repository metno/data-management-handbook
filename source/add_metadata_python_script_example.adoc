[[example-script-add-metadata]]
===== Example script to create a NetCDF-CF file

Suppose you have a dataset with the following variables in a NetCDF-CF file:

* Wind speed at 10 meter height (CF standard name: wind_speed)
* Wind direction at 10 meter height (CF standard name: wind_from_direction)

The below is an example python script to add discovery metadata to the netCDF-CF file. Note that we have only included the required attributes, and that the data producer should add the recommended ones as well. This is needed to support (meta)data interoperability. The resulting file can be validated by the script `scripts/nc2mmd.py` in https://github.com/metno/py-mmd-tools[py-mmd-tools], which also can parse the netCDF-CF file into an MMD xml file:
[source, python]
----
#!/usr/bin/env python

from datetime import datetime, timedelta, timezone
import sys
import netCDF4 as nc
from uuid import uuid4
import os
import warnings

with nc.Dataset(sys.argv[1], "a") as f:
    f.id = str(uuid4())

    isotime_now_utc = datetime.utcnow().replace(tzinfo=timezone.utc).isoformat()
    isotime_now_local = datetime.now().astimezone().replace(microsecond=0).isoformat()
    isotime_now_local_string = str(isotime_now_local)

    script_name = os.path.basename(__file__)

    if 'history' not in f.ncattrs():
        """ History should already exist in the netcdf file but if
        it does not, we create it here.
        """
        f.history = ""
        warnings.warn("Warning: no history field in the netCDF metadata")

    f.history += isotime_now_local_string + ", Dummy User, " + script_name + "\n"


    f.title = 'lorem ipsum'

    f.summary = 'lorem ipsum '
    f.summary += 'lorem ipsum '
    f.summary += 'lorem ipsum'

    f.license = 'https://spdx.org/licenses/CC-BY-4.0(CC-BY-4.0)'

    # example keywords are given here, this must be customized depending on the data at hand
    f.keywords = 'GCMDSK:Earth Science > Atmosphere > Atmospheric radiation, '
    f.keywords += 'GCMDLOC:Geographic Region > Northern Hemisphere, '
    f.keywords += (
                    'GEMET:Meteorological geographical features, '
                    'GEMET:Atmospheric conditions, '
                )
    f.keywords += (
                    'GEMET:Oceanographic geographical features, '
                    'NORTHEMES:Weather and climate'
                )
    f.keywords_vocabulary = (
                    'GCMDSK:GCMD Science Keywords:https://gcmd.'
                    'earthdata.nasa.gov/kms/concepts/concept_scheme/'
                    'sciencekeywords, '
                )
    f.keywords_vocabulary += (
                    'GEMET:INSPIRE themes:http://inspire.ec.europa.eu'
                    '/theme, '
                )
    f.keywords_vocabulary += (
                    'NORTHEMES:GeoNorge Themes:https://register.'
                    'geonorge.no/subregister/metadata-kodelister/'
                    'kartverket/nasjonal-temainndeling'
                )

    f.naming_authority = 'no.met'

    # extracting f.time_coverage_start and f.time_coverage_end from the time variable
    coverstart = f.variables['time'][0] # time of first measurement
    coverend = f.variables['time'][-1]  # time of last measurement

    # we assume here that the time variable contains timesteps in UTC
    try:
        f.time_coverage_start = datetime.fromtimestamp(coverstart).replace(tzinfo=timezone.utc).isoformat()
    except:
        warnings.warn("Warning: conversion of first timestep to datetime in ISO format failed, setting time_coverage_start as ")

    try:
       f.time_coverage_end = datetime.fromtimestamp(coverend).replace(tzinfo=timezone.utc).isoformat()
    except:
        warnings.warn("Conversion of last timestep to datetime in ISO format failed, time_coverage_end will not be set")

    if not 'date_created' in f.ncattrs():
        warnings.warn("Warning: date_created field does not exist")
        """ We try to extract the creation date from pre-existing fields, this does not
            cover all possible cases, customize this according to your netcdf file
        """
        if 'created_date' in f.ncattrs():
            if 'created_hour' in f.ncattrs():
                try :
                    f.date_created = datetime.strptime(f.created_date+'T'+f.created_hour,'%Y%m%dT%H%M%S.%f').replace(tzinfo=timezone.utc).isoformat()
                except:
                    warnings.warn("Warning: created_date or created_hour are not in the expected format, date_created will use the current time in UTC")
                    f.date_created = isotime_now_utc
            else:
                try:
                    f.date_created = datetime.strptime(f.created_date,'%Y%m%d').replace(tzinfo=datetime.timezone.utc).isoformat()
                    warnings.warn("Warning: using current created_date and midnight time in UTC to fill the date_created field")
                except:
                    warnings.warn("Warning: created_date is not in the expected format, date_created will use the current time in UTC")
                    f.date_created = isotime_now_utc
        else:
            warnings.warn("Warning: filling the date_created field with the current time in UTC")
            f.date_created = isotime_now_utc

    f.Conventions = 'CF-1.6, ACDD-1.3'

    f.geospatial_lat_min = 30.05
    f.geospatial_lat_max = 81.95
    f.geospatial_lon_min = -29.95
    f.geospatial_lon_max = 89.95

    f.iso_topic_category = 'climatologyMeteorologyAtmosphere,environment'

    f.spatial_representation = 'grid'
----
